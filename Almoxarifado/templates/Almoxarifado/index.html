{% extends 'base.html' %}


{%block 'header'%}
<h2>{{app_name}}</h2>
{%endblock%}

{% block 'main' %}
{% include 'static/imports/bootstrap_tables.html' %}
<div class="accordion mt-3">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#menu-repor"
        aria-expanded="false">
        Repor EPI vencido
      </button>
    </h2>
    <div id="menu-repor" class="accordion-collapse collapse">
      <table data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/repor"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th colspan="3">COLABORADOR</th>
            <th colspan="5">PRODUTO</th>
            <th rowspan="2" data-formatter="entregarFormatter" data-events="btnEvents"></th>

          </tr>
          <tr>
            <th data-field="id_colab">ID</th>
            <th data-field="nome">Nome</th>
            <th data-field="funcao">Função</th>
            <th data-field="id_produto">ID</th>
            <th data-field="produto">Nome</th>
            <th data-field="tamanho">Tamanho</th>
            <th data-field="reposicao" data-formatter="dataFormatter">Validade</th>
            <th data-field="situacao" data-formatter="epi_vencido">Situação</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#menu-papel"
        aria-expanded="false">
        Passar para ficha física
      </button>
    </h2>
    <div id="menu-papel" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">
      <table data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/papel"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th colspan="3">COLABORADOR</th>
            <th colspan="5">PRODUTO</th>
            <th rowspan="2" data-formatter="entregarFormatter" data-events="btnEvents"></th>

          </tr>
          <tr>
            <th data-field="id_colab">ID</th>
            <th data-field="nome">Nome</th>
            <th data-field="funcao">Função</th>
            <th data-field="id_produto">ID</th>
            <th data-field="produto">Nome</th>
            <th data-field="tamanho">Tamanho</th>
            <th data-field="reposicao" data-formatter="dataFormatter">Validade</th>
            <th data-field="situacao">Situação</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#menu-baixar"
        aria-expanded="false">
        Baixar no Tecnicon
      </button>
    </h2>
    <div id="menu-baixar" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">


      <table id="tabela_baixar" data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/baixar"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th rowspan="2" data-field="obra">Obra [cr]</th>
            <th colspan="6">EPI</th>
            <th rowspan="2" data-formatter="baixarFormatter" data-events="btnEvents"></th>

          </tr>
          <tr>
            <th data-field="id">ID</th>
            <th data-field="quantidade">Quantidade</th>
            <th data-field="produto">Produto</th>
            <th data-field="ca">CA</th>
            <th data-field="validade" data-formatter="dataFormatter">Validade</th>
            <th data-field="tamanho">Tamanho</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#menu-assinar"
        aria-expanded="false">
        Assinar a ficha
      </button>
    </h2>
    <div id="menu-assinar" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">
      <table id="tabela_assinar" data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/assinar"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th rowspan="2" data-field="id_colab">ID</th>
            <th rowspan="2" data-field="colaborador">Colaborador</th>
            <th colspan="2">EPI</th>
            <th rowspan="2" data-formatter="assinarFormatter" data-events="btnEvents"></th>
          </tr>
          <tr>
            <th data-field="novos_produtos">Produtos</th>
            <th data-field="data_entrega" data-formatter="dataFormatter">Entrega</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>
<div class="accordion mt-3">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
        data-bs-target="#menu-digitalizar" aria-expanded="false">
        Digitalizar ficha completa
      </button>
    </h2>
    <div id="menu-digitalizar" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">
      <table data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/digitalizar"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th rowspan="2" data-field="id">ID</th>
            <th colspan="2">COLABORADOR</th>
            <th rowspan="2" data-field="pagina">Página</th>
            <th rowspan="2" data-field="data_finalizado">Finalizado em</th>
            <th rowspan="2" data-field="data_digitalizacao">Digitalizado em</th>
            <th rowspan="2" data-formatter="digitalizarFormatter" data-events="btnEvents">Ação</th>
          </tr>
          <tr>
            <th data-field="colaborador">ID</th>
            <th data-field="nome">Nome</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#menu-arquivar"
        aria-expanded="false">
        Arquivar ficha sem item valido
      </button>
    </h2>
    <div id="menu-arquivar" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">
      <table data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/arquivar"
        class="table table-hover table-bordered table-striped table-sm" id="tabela_arquivar">
        <thead>
          <th data-field="id">Ficha ID</th>
          <th data-field="nome">colaborador</th>
          <th data-field="pagina">página</th>
          <th data-formatter="arquivarFormatter" data-events="btnEvents">Ação</th>
        </thead>
      </table>
    </div>
  </div>
</div>
<div class="accordion mt-3">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
        data-bs-target="#menu-ca" aria-expanded="false">
        Validades CA
      </button>
    </h2>
    <div id="menu-ca" class="accordion-collapse collapse mb-3" data-bs-parent="#accordion">
      <table data-toggle="table" data-locale="pt-BR" data-url="{{api}}Almoxarifado/tabela/validade_ca"
        class="table table-hover table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th data-field="id">ID</th>
            <th data-field="produto">PRODUTO</th>
            <th data-field="fabricante">FABRICANTE</th>
            <th data-field="ca">CA</th>
            <th data-field="validade" data-formatter="dataFormatter">Validade</th>
            <th data-field="situacao" data-formatter="ca_vencido" >SITUAÇÃO</th>
            <th data-formatter="atualizarFormatter" data-events="btnEvents">Ação</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>
<script>
  function entregarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-check2-square fs-6 me-1" id="entregarBtn" title="Entregue"></div>'
    )
  }
  function epi_vencido(value) {
    switch (value) {
      case 'Vencido':
      return `<h6 class='m-0'><span class="badge bg-danger text-uppercase">${value}</span></h6>`
      default:
      return `<h6 class='m-0'><span class="badge bg-warning text-uppercase">${value}</span></h6>`
        }
}
  function baixarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-arrow-down-circle fs-6 me-1" id="baixarBtn" title="Baixar"></div>'
    )
  }
  function assinarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-pencil fs-6 me-1" id="assinarBtn" title="Assinar"></div>'
    )
  }
  function digitalizarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-file-break fs-6 me-1" id="digitalizarBtn" title="Digitalizar"></div>'
    )
  }
  function arquivarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-archive-fill fs-6 me-1" id="arquivarBtn" title="Arquivar"></div>'
    )
  }
  function ca_vencido(value) {
    switch (value) {
      case 'VENCIDO':
      return `<h6 class='m-0'><span class="badge bg-danger text-uppercase">${value}</span></h6>`
      default:
      return `<h6 class='m-0'><span class="badge bg-warning text-uppercase">${value}</span></h6>`
        }
}
  function atualizarFormatter() {
    return (
      '<div class="btn-icon bg-info bi-send-check" id="atualizarBtn" title="Atualizar"></div>'
    )
  }
  window.btnEvents = {
    'click #entregarBtn': function (e, value, row, index) {
      page.to('/Almoxarifado/cadastros/epi_movimentacao',{'produto':row['id_produto'],'colaborador':row['id_colab'],'reposicao':'T','voltar':'inicio'})
    },
    'click #baixarBtn': function (e, value, row, index) {
      apiRequest.post('funcao/baixar_tecnicon', { 'epi': row['id'], 'obra': row['obra'] }).then(() => {
        $('#tabela_baixar').bootstrapTable('refresh')
      })
    },
    'click #assinarBtn': function (e, value, row, index) {
      apiRequest.post('funcao/assinar', { 'colab': row['id_colab'], 'data': row['data_entrega'] }).then(() => {
        $('#tabela_assinar').bootstrapTable('refresh')
      })
    },
    'click #digitalizarBtn': function (e, value, row, index) {
      window.location.href = `${window.location.origin}/Almoxarifado/cadastros/digitalizacao?ficha=${row['id']}&colaborador=${row['colaborador']}`;
    },
    'click #arquivarBtn': function (e, value, row, index) {
      apiRequest.get('ficha/' + row['id']).then((result) => {
        result['arquivado'] = true
        apiRequest.update('ficha/' + row['id'], result)
        $('#tabela_arquivar').bootstrapTable('refresh')
      })
    },
    'click #atualizarBtn': function (e, value, row, index) {
      let modal = new Modal('epi_cadastro', "update");
      modal.open(row['id']);
    },

  }
</script>
{% endblock %}